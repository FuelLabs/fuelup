name: Index Version Sets

on:
  push
    # schedule:
    # Run at minute 0 and 30 every hour
    # - cron: '0,30 * * * *'
env:
  LATEST_CHANNEL_DIR: ./channel-fuel-latest.toml.d/

jobs:
  compare-versions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.set-should-run.outputs.should_run }}
      forc-versions: ${{ steps.set-versions.outputs.forc-versions }}
      fuel-core-versions: ${{ steps.set-versions.outputs.fuel-core-versions }}
    steps:
      - name: checkout master
        uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - uses: Swatinem/rust-cache@v1
      - id: set-should-run
        run: echo "::set-output should_run=true"
      - id: set-versions
        run: |
          cargo install --debug --path ./scripts/compare-versions
          compare-versions >> out
          FORC_VERSIONS=$(head -n 1 out)
          FUEL_CORE_VERSIONS=$(tail -1 out)
          echo "::set-output name=forc-versions::${FORC_VERSIONS}"
          echo "::set-output name=fuel-core-versions::${FUEL_CORE_VERSIONS}"

  test-compatibility:
    needs: compare-versions
    uses: ./.github/workflows/test-toolchain-compatibility.yml
    with:
      forc-versions: ${{ needs.compare-versions.outputs.forc-versions }}
      fuel-core-versions: ${{ needs.compare-versions.outputs.fuel-core-versions }}
