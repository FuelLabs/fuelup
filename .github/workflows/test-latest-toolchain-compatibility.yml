name: Test toolchain compatibility (Latest)

on:
  workflow_call:
    inputs:
      fuel-core-version:
        required: true
        type: string
      forc-version:
        required: true
        type: string
    output:
      incompatible:
        description: "Describes if the forc and fuel-core tested are incompatible"
          value: ${{ jobs.test-toolchain-compatibility.outputs.incompatible }}

jobs:
  format-fuel-core-image:
    runs-on: ubuntu-latest
    outputs:
      fuel-core-image: ${{ steps.get-fuel-core-image.outputs.fuel-core-image }}
    steps:
      - name: Set Fuel Core latest image
        id: get-fuel-core-image
        run: |
          echo ${{ inputs.fuel-core-version }}
          echo "::set-output name=fuel-core-image::ghcr.io/fuellabs/fuel-core:${{ inputs.fuel-core-version }}"

  test-toolchain-compatibility:
    needs: format-fuel-core-image
    runs-on: ubuntu-latest
    outputs:
      incompatible: ${{ steps.mark-failed.outputs.incompatible }}
    services:
      fuel-core:
        image: ${{ needs.format-fuel-core-image.outputs.fuel-core-image }}
        ports:
          - 4000:4000
    steps:
      - name: Checkout Sway repo
        uses: actions/checkout@v3
        with:
          repository: fuellabs/sway
          path: . 
          ref: ${{ inputs.forc-version }}

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - uses: Swatinem/rust-cache@v1

      - name: Install Forc
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: --debug --path ./forc

      - name: Install Forc fmt
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: --debug --path ./forc-plugins/forc-fmt

      - name: Cargo Run E2E Tests
        id: e2e-tests
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --locked --release --bin test -- --locked

      - name: Build Sway examples
        id: build-examples
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --locked --bin examples-checker build --all-examples

      - name: Build All Tests
        run: cd test/src/sdk-harness && bash build.sh --locked && cd ../../../

      - name: Cargo Test sway-lib-std
        id: test-std-lib
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --manifest-path ./test/src/sdk-harness/Cargo.toml -- --test-threads=1 --nocapture

      - name: Mark failed
        if: ${{ failure() && (steps.e2e-tests.conclusion == 'failure' || steps.build-examples.conclusion == 'failure' || steps.test-std-lib.conclusion == 'failure'  )}}
        run: |
          echo "::set-output name=incompatible::true"
