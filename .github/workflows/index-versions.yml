name: Index Version Sets

on:
  push
    # schedule:
    # Run at minute 0 and 30 every hour
    # - cron: '0,30 * * * *'
env:
  LATEST_CHANNEL_DIR: ./channel-fuel-latest.toml.d/

jobs:
  compare-versions:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.set-vars.outputs.should-run }}
      forc-versions: ${{ steps.set-vars.outputs.forc-versions }}
      fuel-core-versions: ${{ steps.set-vars.outputs.fuel-core-versions }}
    steps:
      - name: checkout master
        uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - uses: Swatinem/rust-cache@v1
      - name: Install compare-versions script
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: --debug --path ./scripts/compare-versions
      - name: Compare versions and set variables for tests if needed
        id: set-vars
        run: |
          compare-versions >> out

          echo "results:"
          cat out
          if [ -s out ]; then
            echo "New versions detected, running tests"

            FORC_VERSIONS=$(head -n 1 out)
            FUEL_CORE_VERSIONS=$(tail -1 out)

            echo "::set-output name=should-run::true"
            echo "::set-output name=forc-versions::${FORC_VERSIONS}"
            echo "::set-output name=fuel-core-versions::${FUEL_CORE_VERSIONS}"
          else
            echo "No new versions; exiting"
          fi

  test-compatibility:
    needs: compare-versions
    uses: ./.github/workflows/test-toolchain-compatibility.yml
    with:
      forc-versions: ${{ needs.compare-versions.outputs.forc-versions }}
      fuel-core-versions: ${{ needs.compare-versions.outputs.fuel-core-versions }}
    if: ${{ needs.compare-versions.outputs.should-run == false }}
