name: Test toolchain compatibility (Latest)

on:
  workflow_dispatch:
    inputs:
      forc-versions:
        required: true
        type: string
      fuel-core-versions:
        required: true
        type: string
  workflow_call:
    inputs:
      forc-versions:
        required: true
        type: string
      fuel-core-versions:
        required: true
        type: string

env:
  INCOMPATIBLE_DIR: ./incompatible-versions
  LATEST_CHANNEL_DIR: ./channel-fuel-latest.toml.d/
  IS_INCOMPATIBLE: false

jobs:
  test-toolchain-compatibility:
    runs-on: ubuntu-latest
    outputs:
      should-index: ${{ steps.set-should-index.outputs.should-index }}
    strategy:
      fail-fast: false 
      matrix:
        forc-version: ${{ fromJSON(inputs.forc-versions) }}
        fuel-core-version: ${{ fromJSON(inputs.fuel-core-versions) }} 
    services:
      fuel-core:
        image: ghcr.io/fuellabs/fuel-core:v${{ matrix.fuel-core-version }}
        ports:
          - 4000:4000
    steps:
      - name: Checkout fuelup repo
        uses: actions/checkout@v3
        with:
          repository: fuellabs/fuelup
          path: .
          ref: gh-pages

      - name: Skip tests if already incompatible
        run: |
          FORMATTED_STRING="forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}"
          if [ -d incompatible-versions ]; then
            ls incompatible-versions | grep -x $FORMATTED_STRING
            if [ -s $FORMATTED_STRING ]; then
              echo "Versions incompatible; skipping tests and exiting"
              echo "IS_INCOMPATIBLE=true" >> $GITHUB_ENV
            fi
          fi

      - name: Checkout Sway repo
        uses: actions/checkout@v3
        with:
          repository: fuellabs/sway
          path: . 
          ref: v${{ matrix.forc-version }}

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - uses: Swatinem/rust-cache@v1

      - name: Cargo Run E2E Tests 
        if: ${{ env.IS_INCOMPATIBLE != true }}
        id: e2e-tests
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --locked --release --bin test -- --locked

      - name: Build All Tests
        if: ${{ env.IS_INCOMPATIBLE != true }}
        run: cd test/src/sdk-harness && bash build.sh --locked && cd ../../../

      - name: Cargo Test sway-lib-std
        if: ${{ env.IS_INCOMPATIBLE != true }}
        id: std-lib-tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --manifest-path ./test/src/sdk-harness/Cargo.toml -- --test-threads=1 --nocapture

      - name: Create failure artifact
        if: ${{ failure() && (steps.e2e-tests.conclusion == 'failure' || steps.std-lib-tests.conclusion == 'failure' )}}
        run: |
          touch incompatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}

      - name: Upload failure artifact
        if: ${{ failure() && (steps.e2e-tests.conclusion == 'failure' || steps.std-lib-tests.conclusion == 'failure' ) }}
        id: upload-failure-artifact
        uses: actions/upload-artifact@v3
        with:
          name: incompatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}
          path: incompatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}

      - name: Create success artifact
        if: ${{ success() }}
        run: |
          touch compatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}

      - name: Upload success artifact
        if: ${{ success() }}
        id: upload-success-artifact
        uses: actions/upload-artifact@v3
        with:
          name: compatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}
          path: compatible-forc-${{ matrix.forc-version }}@fuel-core-${{ matrix.fuel-core-version }}

      - name: Trigger index-versions
        if: ${{ steps.upload-success-artifact.conclusion == 'success' || steps.upload-failure-artifact.conclusion == 'success' }}
        id: set-should-index
        run: echo "::set-output name=should-index::true"



  index-versions:
    name: Log latest compatible versions that passed tests
    needs: test-toolchain-compatibility
    if: ${{ always() && needs.test-toolchain-compatibility.outputs.should-index }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          path: versions

      - name: Prepare compatible and incompatible versions
        working-directory: versions
        run: |
            COMPATIBLE_VERSIONS=$(ls compatible* -1 | sort -rV | head -n 1)
            echo "LATEST_COMPATIBLE_FORC=$(echo $COMPATIBLE_VERSIONS | cut -d '@' -f1 | cut -d '-' -f3-)" >> $GITHUB_ENV
            echo "LATEST_COMPATIBLE_FUEL_CORE=$(echo $COMPATIBLE_VERSIONS | cut -d '@' -f2 | cut -d '-' -f3)" >> $GITHUB_ENV

            INCOMPATIBLE_VERSIONS=$(ls | grep 'incompatible' | cut -d '-' -f2-)
            mkdir -p ${{ env.INCOMPATIBLE_DIR }}
            for version in $INCOMPATIBLE_VERSIONS; do
              touch ${{ env.INCOMPATIBLE_DIR }}/$version
            done

      - name: Prepare channel with compatible versions
        run: |
            touch channel-fuel-latest.toml
            mkdir -p ${{ env.LATEST_CHANNEL_DIR }}
            ./.github/workflows/scripts/index-versions.sh ${{ env.LATEST_COMPATIBLE_FORC }} ${{ env.LATEST_COMPATIBLE_FUEL_CORE }}
            cp channel-fuel-latest.toml ${{ env.LATEST_CHANNEL_DIR }}
        if: ${{ env.LATEST_COMPATIBLE_FORC && env.LATEST_COMPATIBLE_FUEL_CORE }}

      - name: Deploy latest channel
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.LATEST_CHANNEL_DIR }}
          keep_files: true
          destination_dir: ./
        if: ${{ env.LATEST_COMPATIBLE_FORC && env.LATEST_COMPATIBLE_FUEL_CORE }}

      - name: Deploy incompatible versions
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: versions/incompatible-versions
          keep_files: true
          destination_dir: ${{ env.INCOMPATIBLE_DIR }}
