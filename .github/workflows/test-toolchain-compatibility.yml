name: Test toolchain compatibility (Latest)

on:
  workflow_dispatch:
    inputs:
      version-matrix:
        required: true
        type: string
  workflow_call:
    inputs:
      version-matrix:
        required: true
        type: string

env:
  INCOMPATIBLE_DIR: ./incompatible-versions
  LATEST_CHANNEL_DIR: ./channel-fuel-latest.toml.d/

jobs:
  test-toolchain-compatibility:
    name: Test forc-${{ matrix.job.forc-version }} against fuel-core-${{ matrix.job.fuel-core-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false 
      matrix: ${{ fromJSON(inputs.version-matrix) }}
    services:
      fuel-core:
        image: ghcr.io/fuellabs/fuel-core:v${{ matrix.job.fuel-core-version }}
        ports:
          - 4000:4000

    steps:
      - name: Checkout Sway repo @ v${{ matrix.job.forc-version }}
        uses: actions/checkout@v3
        with:
          repository: fuellabs/sway
          path: . 
          ref: v${{ matrix.job.forc-version }}

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - uses: Swatinem/rust-cache@v1

      - name: Cargo Run E2E Tests 
        id: e2e-tests
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --locked --release --bin test -- --locked

      - name: Build All Tests
        run: cd test/src/sdk-harness && bash build.sh --locked && cd ../../../

      - name: Cargo Test sway-lib-std
        id: std-lib-tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --manifest-path ./test/src/sdk-harness/Cargo.toml -- --test-threads=1 --nocapture

      # We have to explicitly check for:
      # 1) e2e-tests.conclusion == 'failure'
      # 2) std-lib-tests.conclusion == 'failure'
      # So that we create failure artifacts if and only if tests fail, and not the setup.
      - name: Create failure artifact
        if: ${{ failure() && (steps.e2e-tests.conclusion == 'failure' || steps.std-lib-tests.conclusion == 'failure' )}}
        run: touch incompatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}

      - name: Upload failure artifact
        if: ${{ failure() && (steps.e2e-tests.conclusion == 'failure' || steps.std-lib-tests.conclusion == 'failure' ) }}
        id: upload-failure-artifact
        uses: actions/upload-artifact@v3
        with:
          name: incompatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}
          path: incompatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}

      # Success artifacts are created if everything above passed. This marks the 2 versions as compatible.
      - name: Create success artifact
        if: ${{ success() }}
        run: touch compatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}

      - name: Upload success artifact
        if: ${{ success() }}
        id: upload-success-artifact
        uses: actions/upload-artifact@v3
        with:
          name: compatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}
          path: compatible-forc-${{ matrix.job.forc-version }}@fuel-core-${{ matrix.job.fuel-core-version }}

  index-versions:
    name: Index versions compatibilities
    needs: test-toolchain-compatibility
    if: needs.test-toolchain-compatibility.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          path: versions

      # Here, we decide which versions to mark as compatible or incompatible.
      # Compatible: the uploaded artifact starting with the name 'compatible*' and is at the top when sorted.
      # Incompatible: all the uploaded artifacts that has 'incompatible' in file names, followed by their versions.
      - name: Prepare compatible and incompatible versions
        id: prep-versions
        working-directory: versions
        run: |
            COMPATIBLE_VERSIONS=$(ls compatible* -1 | sort -rV | head -n 1)
            echo "LATEST_COMPATIBLE_FORC=$(echo $COMPATIBLE_VERSIONS | cut -d '@' -f1 | cut -d '-' -f3-)" >> $GITHUB_ENV
            echo "LATEST_COMPATIBLE_FUEL_CORE=$(echo $COMPATIBLE_VERSIONS | cut -d '@' -f2 | cut -d '-' -f3)" >> $GITHUB_ENV

            INCOMPATIBLE_VERSIONS=$(ls | grep 'incompatible' | cut -d '-' -f2-)
            mkdir -p ${{ env.INCOMPATIBLE_DIR }}
            for version in $INCOMPATIBLE_VERSIONS; do
              touch ${{ env.INCOMPATIBLE_DIR }}/$version
            done

      # Run index-versions.sh here which generates the channel TOML file with download links and hashes for forc and fuel-core.
      - name: Prepare channel with compatible versions
        run: |
            touch channel-fuel-latest.toml
            mkdir -p ${{ env.LATEST_CHANNEL_DIR }}
            ./.github/workflows/scripts/index-versions.sh ${{ env.LATEST_COMPATIBLE_FORC }} ${{ env.LATEST_COMPATIBLE_FUEL_CORE }}
            cp channel-fuel-latest.toml ${{ env.LATEST_CHANNEL_DIR }}
        if: ${{ env.LATEST_COMPATIBLE_FORC && env.LATEST_COMPATIBLE_FUEL_CORE }}

      - name: Deploy latest channel
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.LATEST_CHANNEL_DIR }}
          keep_files: true
          destination_dir: ./
        if: ${{ env.LATEST_COMPATIBLE_FORC && env.LATEST_COMPATIBLE_FUEL_CORE }}

      - name: Deploy incompatible versions
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: versions/incompatible-versions
          keep_files: true
          destination_dir: ${{ env.INCOMPATIBLE_DIR }}
